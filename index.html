<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–∏—Ç–≤–∞ –ì–µ—Ä–æ–µ–≤</title>
    <style>
        :root {
            --primary: #4a148c;
            --secondary: #ff6f00;
            --accent: #e91e63;
            --light: #f5f5f5;
            --dark: #212121;
            --success: #4caf50;
            --danger: #f44336;
            --warning: #ffc107;
            --info: #2196f3;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f0e6ff;
            color: var(--dark);
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1, h2, h3 {
            color: var(--primary);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        .tab {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .active {
            display: block;
        }
        
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .tab-btn:hover {
            background-color: var(--secondary);
            transform: translateY(-2px);
        }
        
        .tab-btn.active {
            background-color: var(--accent);
        }
        
        .coins-display {
            background-color: var(--warning);
            color: var(--dark);
            padding: 10px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .character-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-left: 5px solid var(--primary);
            transition: transform 0.3s;
        }
        
        .character-card:hover {
            transform: translateY(-5px);
        }
        
        .character-card h3 {
            margin-top: 0;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .character-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .stats {
            display: flex;
            gap: 15px;
            margin: 10px 0;
        }
        
        .stat {
            background-color: var(--light);
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 0.9em;
        }
        
        .hp-bar, .ability-bar {
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin: 5px 0;
            overflow: hidden;
        }
        
        .hp-fill {
            height: 100%;
            background-color: var(--success);
            width: 100%;
            transition: width 0.3s;
        }
        
        .ability-fill {
            height: 100%;
            background-color: var(--info);
            width: 0%;
            transition: width 0.3s;
        }
        
        .abilities {
            margin-top: 10px;
        }
        
        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: scale(1.05);
        }
        
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-primary {
            background-color: var(--primary);
        }
        
        .btn-secondary {
            background-color: var(--secondary);
        }
        
        .btn-danger {
            background-color: var(--danger);
        }
        
        .btn-success {
            background-color: var(--success);
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: var(--dark);
        }
        
        .btn-info {
            background-color: var(--info);
        }
        
        .battle-area {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .allies, .enemies {
            flex: 1;
            min-width: 300px;
        }
        
        .battle-log {
            background-color: var(--dark);
            color: white;
            padding: 15px;
            border-radius: 10px;
            height: 300px;
            overflow-y: auto;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid #444;
        }
        
        .log-entry.player {
            color: var(--success);
        }
        
        .log-entry.enemy {
            color: var(--danger);
        }
        
        .log-entry.ability {
            color: var(--info);
        }
        
        .log-entry.heal {
            color: var(--warning);
        }
        
        .enemy-card {
            background-color: #ffebee;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-left: 5px solid var(--danger);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .enemy-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .enemy-card.selected {
            border-left: 5px solid var(--warning);
            background-color: #fff8e1;
        }
        
        .enemy-card.big {
            background-color: #ffccbc;
            border-left: 5px solid var(--secondary);
        }
        
        .chest {
            background-color: var(--warning);
            color: var(--dark);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .chest:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }
        
        .chest-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .upgrade-card {
            background-color: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-left: 5px solid var(--success);
        }
        
        .progress-container {
            margin-top: 10px;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .progress-bar {
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--success);
            width: 0%;
            transition: width 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 1.5s infinite;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: var(--dark);
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8em;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        .character-card.selected {
            box-shadow: 0 0 0 3px var(--info);
        }
        
        .round-indicator {
            background-color: var(--accent);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .tutorial {
            background-color: var(--light);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid var(--info);
        }
        
        .tutorial h3 {
            color: var(--info);
            margin-top: 0;
        }
        
        .damage-animation {
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }
    </style>
</head>
<body>
    <h1>‚öîÔ∏è –ë–∏—Ç–≤–∞ –ì–µ—Ä–æ–µ–≤ üõ°Ô∏è</h1>
    
    <div class="coins-display">
        üí∞ –ú–æ–Ω–µ—Ç—ã: <span id="coins">0</span>
    </div>
    
    <div class="round-indicator">
        üèÜ –†–∞—É–Ω–¥: <span id="round">1</span>
    </div>
    
    <div class="tab-buttons">
        <button class="tab-btn active" onclick="showTab('characters')">üë• –ü–µ—Ä—Å–æ–Ω–∞–∂–∏</button>
        <button class="tab-btn" onclick="showTab('battle')">‚öîÔ∏è –ë–∏—Ç–≤–∞</button>
        <button class="tab-btn" onclick="showTab('upgrades')">üîß –£–ª—É—á—à–µ–Ω–∏—è</button>
        <button class="tab-btn" onclick="showTab('chest')">üéÅ –°—É–Ω–¥—É–∫</button>
    </div>
    
    <div id="characters" class="tab active">
        <h2>üë• –í–∞—à–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏</h2>
        
        <div class="tutorial">
            <h3>–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è! v:alpha 1</h3>
            <p>1. —Ç–µ—Å—Ç</p>
        
        </div>
        
        <div id="characters-container">
            <!-- –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </div>
    
    <div id="battle" class="tab">
        <h2>‚öîÔ∏è –ë–∏—Ç–≤–∞</h2>
        
        <div class="battle-controls">
            <button id="start-battle-btn" class="btn btn-primary" onclick="startBattle()">–ù–∞—á–∞—Ç—å –±–æ–π</button>
            <button id="end-turn-btn" class="btn btn-danger" onclick="endTurn()" disabled>–ó–∞–∫–æ–Ω—á–∏—Ç—å —Ö–æ–¥</button>
        </div>
        
        <div class="battle-area">
            <div class="allies">
                <h3>üë®‚Äçüë®‚Äçüë¶‚Äçüë¶ –í–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞</h3>
                <div id="allies-container">
                    <!-- –°–æ—é–∑–Ω–∏–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
            
            <div class="enemies">
                <h3>üëπ –ü—Ä–æ—Ç–∏–≤–Ω–∏–∫–∏</h3>
                <div id="enemies-container">
                    <!-- –ü—Ä–æ—Ç–∏–≤–Ω–∏–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>
        
        <div class="battle-log">
            <h3>üìú –õ–æ–≥ –±–∏—Ç–≤—ã</h3>
            <div id="battle-log-container">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±–æ—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>
    
    <div id="upgrades" class="tab">
        <h2>üîß –£–ª—É—á—à–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</h2>
        
        <div id="upgrades-container">
            <!-- –£–ª—É—á—à–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </div>
    
    <div id="chest" class="tab">
        <h2>üéÅ –í–æ–ª—à–µ–±–Ω—ã–π —Å—É–Ω–¥—É–∫</h2>
        
        <div class="chest pulse" onclick="openChest()">
            <div class="chest-icon">üéÅ</div>
            <h3>–û—Ç–∫—Ä—ã—Ç—å —Å—É–Ω–¥—É–∫</h3>
            <p>–°—Ç–æ–∏–º–æ—Å—Ç—å: <span id="chest-price">200</span> –º–æ–Ω–µ—Ç</p>
            <p>–®–∞–Ω—Å—ã:</p>
            <ul style="text-align: left; display: inline-block;">
                <li>50% - –ë–µ–∫–æ–Ω (2 —É—Ä–æ–Ω, 10 HP, —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å)</li>
                <li>30% - –ì–æ—Å—Ç—å (1 —É—Ä–æ–Ω, 20 HP)</li>
                <li>15% - –ö–∏—Ä–ø–∏—á (4 —É—Ä–æ–Ω, 5 HP, –º–æ—â–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å)</li>
                <li>5% - –î–∂–µ–π–Ω –î–æ—É (0 —É—Ä–æ–Ω, 25 HP, –ª–µ—á–∏—Ç —Å–æ—é–∑–Ω–∏–∫–æ–≤)</li>
            </ul>
        </div>
        
        <div id="chest-result" style="text-align: center; margin-top: 20px;">
            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–∫—Ä—ã—Ç–∏—è —Å—É–Ω–¥—É–∫–∞ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
        </div>
    </div>
    <!-- –ü—Ä–µ–º–∏—É–º —Å—É–Ω–¥—É–∫ –≤–æ –≤–∫–ª–∞–¥–∫–µ "–°—É–Ω–¥—É–∫" -->
<div id="premium-chest" class="chest premium" onclick="openPremiumChest()">
    <div class="chest-icon">üíé</div>
    <h3>–ü—Ä–µ–º–∏—É–º —Å—É–Ω–¥—É–∫</h3>
    <p>–°—Ç–æ–∏–º–æ—Å—Ç—å: <span id="premium-chest-price">1000</span> –º–æ–Ω–µ—Ç</p>
    <p>–®–∞–Ω—Å—ã:</p>
    <ul class="chest-chances">
        <li>70% - –¢–∞—Ñ (3 —É—Ä–æ–Ω–∞, 20 HP)</li>
        <li>29% - –ë–∏–ª–¥–µ—Ä–º–µ–Ω (0 —É—Ä–æ–Ω–∞, 25 HP, –±–∞—Ñ—Ñ —Å–æ—é–∑–Ω–∏–∫–æ–≤)</li>
        <li>1% - 007h0 (5 —É—Ä–æ–Ω–∞, 20 HP, –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)</li>
    </ul>
</div>
    <button class="btn btn-ability" onclick="handleAbilityInBattle('builderman')" 
        id="builderman-ability-btn">
    –£—Å–∏–ª–∏—Ç—å —Å–æ—é–∑–Ω–∏–∫–∞ (+2 —É—Ä–æ–Ω–∞)
</button>

<button class="btn btn-ability" onclick="handleAbilityInBattle('agent')" 
        id="agent-ability-btn">
    –°–æ–∑–¥–∞—Ç—å –∫–ª–æ–Ω–∞
</button>
    
    <script>
        // –ò–≥—Ä–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        const gameState = {
            coins: 1000000000,  // –ù–∞—á–∞–ª—å–Ω—ã–µ –º–æ–Ω–µ—Ç—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            round: 1,
            characters: {
                noob: {
                    id: 'noob',
                    name: '–ù—É–±',
                    hp: 5,
                    maxHp: 5,
                    dmg: 1,
                    upgrades: 0,
                    maxUpgrades: 3,
                    upgradeCost: 100,
                    upgradeType: 'hp',
                    icon: 'üë∂',
                    color: '#9c27b0',
                    unlocked: true
                },
                bacon: {
                    id: 'bacon',
                    name: '–ë–µ–∫–æ–Ω',
                    hp: 10,
                    maxHp: 10,
                    dmg: 2,
                    abilityDmg: 5,
                    abilityCooldown: 1,
                    abilityCurrentCooldown: 0,
                    upgrades: 0,
                    maxUpgrades: 3,
                    upgradeCost: 200,
                    upgradeType: 'dmg',
                    icon: 'ü•ì',
                    color: '#ff5722',
                    unlocked: false
                },
                guest: {
                    id: 'guest',
                    name: '–ì–æ—Å—Ç—å',
                    hp: 20,
                    maxHp: 20,
                    dmg: 1,
                    upgrades: 0,
                    maxUpgrades: 10,
                    upgradeCost: 250,
                    upgradeType: 'hp',
                    icon: 'üë§',
                    color: '#607d8b',
                    unlocked: false
                },
                brick: {
                    id: 'brick',
                    name: '–ö–∏—Ä–ø–∏—á',
                    hp: 5,
                    maxHp: 5,
                    dmg: 4,
                    abilityDmg: 10,
                    abilityCooldown: 20,
                    abilityCurrentCooldown: 0,
                    upgrades: 0,
                    maxUpgrades: 5,
                    upgradeCost: 450,
                    upgradeType: 'hp',
                    icon: 'üß±',
                    color: '#795548',
                    unlocked: false
                },
                jane: {
                    id: 'jane',
                    name: '–î–∂–µ–π–Ω –î–æ—É',
                    hp: 25,
                    maxHp: 25,
                    dmg: 0,
                    healAmount: 1,
                    upgrades: 0,
                    maxUpgrades: 0,
                    icon: 'üë©',
                    color: '#e91e63',
                    unlocked: false
                }
            },
            battle: {
                inProgress: false,
                currentRound: 1,
                selectedCharacter: null,
                selectedEnemy: null,
                allies: [],
                enemies: [],
                logs: [],
                waitingForEnemyResponse: false
            },
            chest: {
                basePrice: 200,
                currentPrice: 200,
                priceIncrease: 100
            }
        };
        
        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const coinsElement = document.getElementById('coins');
        const roundElement = document.getElementById('round');
        const chestPriceElement = document.getElementById('chest-price');
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
        function initGame() {
            updateUI();
            renderCharacters();
            renderUpgrades();
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –≤–∫–ª–∞–¥–∫—É
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if (btn.textContent.includes(tabName === 'characters' ? '–ü–µ—Ä—Å–æ–Ω–∞–∂–∏' : 
                                            tabName === 'battle' ? '–ë–∏—Ç–≤–∞' : 
                                            tabName === 'upgrades' ? '–£–ª—É—á—à–µ–Ω–∏—è' : '–°—É–Ω–¥—É–∫')) {
                    btn.classList.add('active');
                }
            });
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updateUI() {
            coinsElement.textContent = gameState.coins;
            roundElement.textContent = gameState.round;
            chestPriceElement.textContent = gameState.chest.currentPrice;
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
        function renderCharacters() {
            const container = document.getElementById('characters-container');
            container.innerHTML = '';
            
            for (const charId in gameState.characters) {
                const char = gameState.characters[charId];
                if (!char.unlocked) continue;
                
                const charElement = document.createElement('div');
                charElement.className = `character-card ${char.id === gameState.battle.selectedCharacter?.id ? 'selected' : ''}`;
                charElement.id = `char-${char.id}`;
                
                let abilitiesHtml = '';
                if (char.abilityDmg) {
                    abilitiesHtml = `
                        <div class="abilities">
                            <p>üí• –°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å: ${char.abilityDmg} —É—Ä–æ–Ω–∞ (–ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞: ${char.abilityCooldown} —Ö–æ–¥${char.abilityCooldown !== 1 ? '–∞' : ''})</p>
                            <div class="ability-bar">
                                <div class="ability-fill" id="ability-${char.id}" style="width: ${(1 - char.abilityCurrentCooldown / char.abilityCooldown) * 100}%"></div>
                            </div>
                        </div>
                    `;
                } else if (char.healAmount) {
                    abilitiesHtml = `
                        <div class="abilities">
                            <p>üíö –õ–µ—á–µ–Ω–∏–µ: +${char.healAmount} HP —Å–æ—é–∑–Ω–∏–∫—É (—Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞ –∞—Ç–∞–∫—É)</p>
                        </div>
                    `;
                }
                
                charElement.innerHTML = `
                    <h3><span class="character-icon" style="background-color: ${char.color}">${char.icon}</span> ${char.name}</h3>
                    <div class="stats">
                        <div class="stat">‚ù§Ô∏è HP: ${char.hp}/${char.maxHp}</div>
                        <div class="stat">‚öîÔ∏è –£—Ä–æ–Ω: ${char.dmg}</div>
                    </div>
                    <div class="hp-bar">
                        <div class="hp-fill" style="width: ${(char.hp / char.maxHp) * 100}%"></div>
                    </div>
                    ${abilitiesHtml}
                `;
                
                container.appendChild(charElement);
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–ª—É—á—à–µ–Ω–∏–π
        function renderUpgrades() {
            const container = document.getElementById('upgrades-container');
            container.innerHTML = '';
            
            for (const charId in gameState.characters) {
                const char = gameState.characters[charId];
                if (!char.unlocked || char.maxUpgrades === 0) continue;
                
                const upgradeElement = document.createElement('div');
                upgradeElement.className = 'upgrade-card';
                
                let upgradeDescription = '';
                if (char.upgradeType === 'hp') {
                    upgradeDescription = `+1 HP (${char.upgradeCost} –º–æ–Ω–µ—Ç)`;
                } else if (char.upgradeType === 'dmg') {
                    upgradeDescription = `+1 —É—Ä–æ–Ω (${char.upgradeCost} –º–æ–Ω–µ—Ç)`;
                }
                
                upgradeElement.innerHTML = `
                    <h3><span class="character-icon" style="background-color: ${char.color}">${char.icon}</span> ${char.name}</h3>
                    <p>${upgradeDescription}</p>
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>–£—Ä–æ–≤–µ–Ω—å: ${char.upgrades}/${char.maxUpgrades}</span>
                            <span id="upgrade-cost-${char.id}">${char.upgradeCost} –º–æ–Ω–µ—Ç</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${(char.upgrades / char.maxUpgrades) * 100}%"></div>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="upgradeCharacter('${char.id}')" 
                        ${gameState.coins < char.upgradeCost || char.upgrades >= char.maxUpgrades ? 'disabled' : ''}>
                        –£–ª—É—á—à–∏—Ç—å
                    </button>
                `;
                
                container.appendChild(upgradeElement);
            }
        }
        
        // –£–ª—É—á—à–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        function upgradeCharacter(charId) {
            const char = gameState.characters[charId];
            
            if (gameState.coins >= char.upgradeCost && char.upgrades < char.maxUpgrades) {
                gameState.coins -= char.upgradeCost;
                
                if (char.upgradeType === 'hp') {
                    char.maxHp += 1;
                    char.hp += 1;
                } else if (char.upgradeType === 'dmg') {
                    char.dmg += 1;
                }
                
                char.upgrades += 1;
                
                addLogMessage(`–£–ª—É—á—à–µ–Ω ${char.name}!`, 'player');
                updateUI();
                renderCharacters();
                renderUpgrades();
            }
        }
        
        // –û—Ç–∫—Ä—ã—Ç–∏–µ —Å—É–Ω–¥—É–∫–∞
        function openChest() {
            if (gameState.coins < gameState.chest.currentPrice) {
                addLogMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Å—É–Ω–¥—É–∫–∞!', 'player');
                return;
            }
            
            gameState.coins -= gameState.chest.currentPrice;
            gameState.chest.currentPrice += gameState.chest.priceIncrease;
            
            const random = Math.random() * 100;
            let unlockedChar = null;
            
            if (random <= 5) {
                unlockedChar = 'jane';
            } else if (random <= 20) {
                unlockedChar = 'brick';
            } else if (random <= 50) {
                unlockedChar = 'guest';
            } else {
                unlockedChar = 'bacon';
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ —É–∂–µ —ç—Ç–æ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂
            if (gameState.characters[unlockedChar].unlocked) {
                // –ï—Å–ª–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂ —É–∂–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω, –¥–∞–µ–º –º–æ–Ω–µ—Ç—ã –≤–º–µ—Å—Ç–æ –Ω–µ–≥–æ
                const refund = Math.floor(gameState.chest.currentPrice * 0.7);
                gameState.coins += refund;
                
                const resultDiv = document.getElementById('chest-result');
                resultDiv.innerHTML = `
                    <div style="background-color: #fff3e0; padding: 15px; border-radius: 10px;">
                        <h3>üéÅ –í—ã –ø–æ–ª—É—á–∏–ª–∏ –¥—É–±–ª–∏–∫–∞—Ç!</h3>
                        <p>–ü–µ—Ä—Å–æ–Ω–∞–∂ ${gameState.characters[unlockedChar].name} —É–∂–µ –µ—Å—Ç—å –≤ –≤–∞—à–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏.</p>
                        <p>–í –∫–∞—á–µ—Å—Ç–≤–µ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ ${refund} –º–æ–Ω–µ—Ç!</p>
                    </div>
                `;
                
                addLogMessage(`–û—Ç–∫—Ä—ã—Ç —Å—É–Ω–¥—É–∫: –¥—É–±–ª–∏–∫–∞—Ç ${gameState.characters[unlockedChar].name}, –ø–æ–ª—É—á–µ–Ω–æ ${refund} –º–æ–Ω–µ—Ç!`, 'player');
            } else {
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –Ω–æ–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
                gameState.characters[unlockedChar].unlocked = true;
                gameState.characters[unlockedChar].hp = gameState.characters[unlockedChar].maxHp;
                
                const resultDiv = document.getElementById('chest-result');
                resultDiv.innerHTML = `
                    <div style="background-color: #e8f5e9; padding: 15px; border-radius: 10px;">
                        <h3>üéâ –ù–æ–≤—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂!</h3>
                        <p>–í—ã –ø–æ–ª—É—á–∏–ª–∏ ${gameState.characters[unlockedChar].name} ${gameState.characters[unlockedChar].icon}</p>
                        <p>${getCharacterDescription(unlockedChar)}</p>
                    </div>
                `;
                
                addLogMessage(`–û—Ç–∫—Ä—ã—Ç —Å—É–Ω–¥—É–∫: –ø–æ–ª—É—á–µ–Ω –Ω–æ–≤—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂ ${gameState.characters[unlockedChar].name}!`, 'player');
            }
            
            updateUI();
            renderCharacters();
            renderUpgrades();
            
            // –ê–Ω–∏–º–∞—Ü–∏—è —Å—É–Ω–¥—É–∫–∞
            const chest = document.querySelector('.chest');
            chest.classList.remove('pulse');
            setTimeout(() => chest.classList.add('pulse'), 100);
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        function getCharacterDescription(charId) {
            const char = gameState.characters[charId];
            
            if (charId === 'noob') {
                return "–ù–æ–≤–∏—á–æ–∫ –≤ –≤–∞—à–µ–π –∫–æ–º–∞–Ω–¥–µ. –ú–æ–∂–µ—Ç –±—ã—Ç—å —É–ª—É—á—à–µ–Ω –¥–æ 3 —É—Ä–æ–≤–Ω—è.";
            } else if (charId === 'bacon') {
                return "–°–∏–ª—å–Ω—ã–π –±–æ–µ—Ü —Å –º–æ—â–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å—é. –ú–æ–∂–µ—Ç –±—ã—Ç—å —É–ª—É—á—à–µ–Ω –¥–æ 3 —É—Ä–æ–≤–Ω—è.";
            } else if (charId === 'guest') {
                return "–í—ã–Ω–æ—Å–ª–∏–≤—ã–π –±–æ–µ—Ü —Å –±–æ–ª—å—à–∏–º –∑–∞–ø–∞—Å–æ–º –∑–¥–æ—Ä–æ–≤—å—è. –ú–æ–∂–µ—Ç –±—ã—Ç—å —É–ª—É—á—à–µ–Ω –¥–æ 10 —É—Ä–æ–≤–Ω—è.";
            } else if (charId === 'brick') {
                return "–ú–æ—â–Ω—ã–π —É–¥–∞—Ä, –Ω–æ –º–∞–ª–æ –∑–¥–æ—Ä–æ–≤—å—è. –ò–º–µ–µ—Ç —Å—É–ø–µ—Ä—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å. –ú–æ–∂–µ—Ç –±—ã—Ç—å —É–ª—É—á—à–µ–Ω –¥–æ 5 —É—Ä–æ–≤–Ω—è.";
            } else if (charId === 'jane') {
                return "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –ø–µ—Ä—Å–æ–Ω–∞–∂, –∫–æ—Ç–æ—Ä—ã–π –ª–µ—á–∏—Ç —Å–æ—é–∑–Ω–∏–∫–æ–≤ –≤–º–µ—Å—Ç–æ –∞—Ç–∞–∫–∏.";
            }
            
            return "";
        }
        
        // –ù–∞—á–∞—Ç—å –±–∏—Ç–≤—É
        function startBattle() {
            if (gameState.battle.inProgress) return;
            
            // –°–æ–∑–¥–∞–µ–º –∫–æ–º–∞–Ω–¥—É —Å–æ—é–∑–Ω–∏–∫–æ–≤
            gameState.battle.allies = [];
            for (const charId in gameState.characters) {
                const char = gameState.characters[charId];
                if (char.unlocked) {
                    gameState.battle.allies.push({
                        ...JSON.parse(JSON.stringify(char)),  // –ö–ª–æ–Ω–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç
                        currentHp: char.hp
                    });
                }
            }
            
            // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞—É–Ω–¥–∞
            gameState.battle.enemies = [];
            
            if (gameState.round >= 3 && gameState.round % 3 === 0) {
                // –ö–∞–∂–¥—ã–π 3-–π —Ä–∞—É–Ω–¥ - –±–æ–ª—å—à–æ–π –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫
                const bigEnemiesCount = Math.floor(gameState.round / 3);
                
                for (let i = 0; i < bigEnemiesCount; i++) {
                    gameState.battle.enemies.push({
                        id: `big-enemy-${i}`,
                        name: '–ë–æ–ª—å—à–æ–π –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫',
                        currentHp: 10,
                        maxHp: 10,
                        dmg: 2,
                        isBig: true
                    });
                }
            } else {
                // –û–±—ã—á–Ω—ã–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∏
                const enemiesCount = gameState.round;
                
                for (let i = 0; i < enemiesCount; i++) {
                    gameState.battle.enemies.push({
                        id: `enemy-${i}`,
                        name: '–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫',
                        currentHp: 5,
                        maxHp: 5,
                        dmg: 1,
                        isBig: false
                    });
                }
            }
            
            gameState.battle.inProgress = true;
            gameState.battle.selectedCharacter = null;
            gameState.battle.selectedEnemy = null;
            gameState.battle.logs = [];
            gameState.battle.waitingForEnemyResponse = false;
            
            document.getElementById('start-battle-btn').disabled = true;
            document.getElementById('end-turn-btn').disabled = false;
            
            renderBattle();
            addBattleLog(`=== –ù–∞—á–∞–ª–æ —Ä–∞—É–Ω–¥–∞ ${gameState.round} ===`, 'info');
            
            if (gameState.round >= 3 && gameState.round % 3 === 0) {
                addBattleLog(`–ü–æ—è–≤–∏–ª—Å—è –±–æ–ª—å—à–æ–π –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫ (10 HP, 2 —É—Ä–æ–Ω–∞)!`, 'enemy');
            } else {
                addBattleLog(`–ü–æ—è–≤–∏–ª–æ—Å—å ${gameState.round} –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–æ–≤!`, 'enemy');
            }
        }
        
        // –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ö–æ–¥
        function endTurn() {
            if (!gameState.battle.inProgress || gameState.battle.waitingForEnemyResponse) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ –∞—Ç–∞–∫–æ–≤–∞–ª–∏
            const allAttacked = gameState.battle.allies.every(ally => 
                ally.hasAttacked || ally.currentHp <= 0);
            
            if (!allAttacked) {
                addBattleLog(`–ù–µ –≤—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ –∞—Ç–∞–∫–æ–≤–∞–ª–∏!`, 'player');
                return;
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –∞—Ç–∞–∫–∏ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ö–æ–¥–∞
            gameState.battle.allies.forEach(ally => {
                ally.hasAttacked = false;
                if (ally.abilityCurrentCooldown > 0) {
                    ally.abilityCurrentCooldown--;
                }
            });
            
            addBattleLog(`--- –•–æ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω ---`, 'info');
            renderBattle();
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–∏—Ç–≤—ã
        function renderBattle() {
            // –°–æ—é–∑–Ω–∏–∫–∏
            const alliesContainer = document.getElementById('allies-container');
            alliesContainer.innerHTML = '';
            
            for (const ally of gameState.battle.allies) {
                const allyElement = document.createElement('div');
                allyElement.className = `character-card ${ally.id === gameState.battle.selectedCharacter?.id ? 'selected' : ''}`;
                allyElement.style.opacity = ally.currentHp <= 0 ? 0.5 : 1;
                allyElement.onclick = () => selectCharacter(ally);
                
                let abilitiesHtml = '';
                if (ally.abilityDmg) {
                    const canUseAbility = ally.abilityCurrentCooldown === 0 && ally.currentHp > 0 && !ally.hasAttacked;
                    
                    abilitiesHtml = `
                        <div class="abilities">
                            <button class="btn btn-info" onclick="useAbility('${ally.id}', event)" ${!canUseAbility ? 'disabled' : ''}>
                                –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å (${ally.abilityDmg} —É—Ä–æ–Ω–∞)
                            </button>
                            <div class="ability-bar">
                                <div class="ability-fill" style="width: ${(1 - ally.abilityCurrentCooldown / ally.abilityCooldown) * 100}%"></div>
                            </div>
                        </div>
                    `;
                } else if (ally.healAmount) {
                    abilitiesHtml = `
                        <div class="abilities">
                            <p>üíö –õ–µ—á–µ–Ω–∏–µ: +${ally.healAmount} HP —Å–æ—é–∑–Ω–∏–∫—É</p>
                        </div>
                    `;
                }
                
                allyElement.innerHTML = `
                    <h3><span class="character-icon" style="background-color: ${gameState.characters[ally.id].color}">${gameState.characters[ally.id].icon}</span> ${ally.name} ${ally.hasAttacked ? '‚úÖ' : ''}</h3>
                    <div class="stats">
                        <div class="stat">‚ù§Ô∏è HP: ${ally.currentHp > 0 ? ally.currentHp : '0'}/${ally.maxHp}</div>
                        <div class="stat">‚öîÔ∏è –£—Ä–æ–Ω: ${ally.dmg}</div>
                    </div>
                    <div class="hp-bar">
                        <div class="hp-fill" style="width: ${(ally.currentHp / ally.maxHp) * 100}%"></div>
                    </div>
                    ${abilitiesHtml}
                `;
                
                alliesContainer.appendChild(allyElement);
            }
            
            // –ü—Ä–æ—Ç–∏–≤–Ω–∏–∫–∏
            const enemiesContainer = document.getElementById('enemies-container');
            enemiesContainer.innerHTML = '';
            
            for (const enemy of gameState.battle.enemies) {
                const enemyElement = document.createElement('div');
                enemyElement.className = `enemy-card ${enemy.isBig ? 'big' : ''} ${enemy.id === gameState.battle.selectedEnemy?.id ? 'selected' : ''}`;
                enemyElement.style.opacity = enemy.currentHp <= 0 ? 0.5 : 1;
                enemyElement.onclick = () => selectEnemy(enemy);
                
                enemyElement.innerHTML = `
                    <h3>${enemy.isBig ? 'üëπ –ë–æ–ª—å—à–æ–π ' : 'üë∫ '}${enemy.name}</h3>
                    <div class="stats">
                        <div class="stat">‚ù§Ô∏è HP: ${enemy.currentHp > 0 ? enemy.currentHp : '0'}/${enemy.maxHp}</div>
                        <div class="stat">‚öîÔ∏è –£—Ä–æ–Ω: ${enemy.dmg}</div>
                    </div>
                    <div class="hp-bar">
                        <div class="hp-fill" style="width: ${(enemy.currentHp / enemy.maxHp) * 100}%"></div>
                    </div>
                `;
                
                enemiesContainer.appendChild(enemyElement);
            }
            
            // –õ–æ–≥ –±–∏—Ç–≤—ã
            const battleLogContainer = document.getElementById('battle-log-container');
            battleLogContainer.innerHTML = '';
            
            for (const log of gameState.battle.logs) {
                const logElement = document.createElement('div');
                logElement.className = `log-entry ${log.type}`;
                logElement.textContent = log.message;
                battleLogContainer.appendChild(logElement);
            }
            
            battleLogContainer.scrollTop = battleLogContainer.scrollHeight;
        }
        
        // –í—ã–±–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –¥–ª—è –∞—Ç–∞–∫–∏
        function selectCharacter(character) {
            if (!gameState.battle.inProgress || 
                gameState.battle.waitingForEnemyResponse || 
                character.currentHp <= 0 ||
                character.hasAttacked) return;
            
            gameState.battle.selectedCharacter = character;
            gameState.battle.selectedEnemy = null;
            renderBattle();
        }
        
        // –í—ã–±–æ—Ä –≤—Ä–∞–≥–∞ –¥–ª—è –∞—Ç–∞–∫–∏
        function selectEnemy(enemy) {
            if (!gameState.battle.inProgress || 
                gameState.battle.waitingForEnemyResponse || 
                !gameState.battle.selectedCharacter || 
                enemy.currentHp <= 0 ||
                gameState.battle.selectedCharacter.hasAttacked) return;
            
            gameState.battle.selectedEnemy = enemy;
            renderBattle();
            
            // –ï—Å–ª–∏ —ç—Ç–æ –î–∂–µ–π–Ω –î–æ—É, —Ç–æ –ª–µ—á–∏–º —Å–æ—é–∑–Ω–∏–∫–∞
            if (gameState.battle.selectedCharacter.id === 'jane') {
                healAlly();
            } else {
                // –û–±—ã—á–Ω–∞—è –∞—Ç–∞–∫–∞
                attackEnemy();
            }
        }
        
        // –ê—Ç–∞–∫–∞ –≤—Ä–∞–≥–∞
        function attackEnemy() {
            const attacker = gameState.battle.selectedCharacter;
            const target = gameState.battle.selectedEnemy;
            
            if (!attacker || !target || attacker.currentHp <= 0 || target.currentHp <= 0 || attacker.hasAttacked) return;
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –∞—Ç–∞–∫–∏
            const enemyElement = document.querySelector(`.enemy-card.selected`);
            if (enemyElement) {
                enemyElement.classList.add('damage-animation');
                setTimeout(() => enemyElement.classList.remove('damage-animation'), 500);
            }
            
            target.currentHp -= attacker.dmg;
            attacker.hasAttacked = true;
            
            addBattleLog(`${attacker.name} –∞—Ç–∞–∫—É–µ—Ç ${target.name} –∏ –Ω–∞–Ω–æ—Å–∏—Ç ${attacker.dmg} —É—Ä–æ–Ω–∞!`, 'player');
            
            if (target.currentHp <= 0) {
                addBattleLog(`${target.name} –ø–æ–≤–µ—Ä–∂–µ–Ω!`, 'player');
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –ø–æ—Å–ª–µ –∞—Ç–∞–∫–∏
            gameState.battle.selectedCharacter = null;
            gameState.battle.selectedEnemy = null;
            
            renderBattle();
            
            // –ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –æ—Ç–≤–µ—á–∞–µ—Ç —É–¥–∞—Ä–æ–º
            setTimeout(enemyResponse, 1000);
        }
        
        // –õ–µ—á–µ–Ω–∏–µ —Å–æ—é–∑–Ω–∏–∫–∞
        function healAlly() {
            const healer = gameState.battle.selectedCharacter;
            
            if (!healer || healer.currentHp <= 0 || healer.hasAttacked) return;
            
            // –ù–∞–π–¥–µ–º –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–Ω–µ–Ω–æ–≥–æ —Å–æ—é–∑–Ω–∏–∫–∞
            const woundedAlly = gameState.battle.allies.find(ally => 
                ally.currentHp > 0 && ally.currentHp < ally.maxHp);
            
            if (woundedAlly) {
                woundedAlly.currentHp += healer.healAmount;
                if (woundedAlly.currentHp > woundedAlly.maxHp) {
                    woundedAlly.currentHp = woundedAlly.maxHp;
                }
                
                // –ê–Ω–∏–º–∞—Ü–∏—è –ª–µ—á–µ–Ω–∏—è
                const allyElement = document.querySelector(`#allies-container .character-card[id="char-${woundedAlly.id}"]`);
                if (allyElement) {
                    allyElement.classList.add('damage-animation');
                    setTimeout(() => allyElement.classList.remove('damage-animation'), 500);
                }
                
                addBattleLog(`${healer.name} –ª–µ—á–∏—Ç ${woundedAlly.name} –Ω–∞ ${healer.healAmount} HP!`, 'heal');
            } else {
                addBattleLog(`${healer.name} –Ω–µ –Ω–∞—à–ª–∞ –∫–æ–≥–æ –ª–µ—á–∏—Ç—å!`, 'player');
            }
            
            healer.hasAttacked = true;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –ø–æ—Å–ª–µ –ª–µ—á–µ–Ω–∏—è
            gameState.battle.selectedCharacter = null;
            gameState.battle.selectedEnemy = null;
            
            renderBattle();
            
            // –ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –æ—Ç–≤–µ—á–∞–µ—Ç —É–¥–∞—Ä–æ–º
            setTimeout(enemyResponse, 1000);
        }
        
        // –û—Ç–≤–µ—Ç–Ω—ã–π —É–¥–∞—Ä –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞
        function enemyResponse() {
            gameState.battle.waitingForEnemyResponse = true;
            
            const aliveEnemies = gameState.battle.enemies.filter(e => e.currentHp > 0);
            const aliveAllies = gameState.battle.allies.filter(a => a.currentHp > 0);
            
            if (aliveEnemies.length === 0 || aliveAllies.length === 0) {
                gameState.battle.waitingForEnemyResponse = false;
                checkBattleEnd();
                return;
            }
            
            // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∂–∏–≤–æ–≥–æ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞
            const enemy = aliveEnemies[Math.floor(Math.random() * aliveEnemies.length)];
            
            // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∂–∏–≤–æ–≥–æ —Å–æ—é–∑–Ω–∏–∫–∞
            const ally = aliveAllies[Math.floor(Math.random() * aliveAllies.length)];
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –∞—Ç–∞–∫–∏
            const allyElement = document.querySelector(`#allies-container .character-card[id="char-${ally.id}"]`);
            if (allyElement) {
                allyElement.classList.add('damage-animation');
                setTimeout(() => allyElement.classList.remove('damage-animation'), 500);
            }
            
            ally.currentHp -= enemy.dmg;
            
            addBattleLog(`${enemy.name} –∞—Ç–∞–∫—É–µ—Ç ${ally.name} –∏ –Ω–∞–Ω–æ—Å–∏—Ç ${enemy.dmg} —É—Ä–æ–Ω–∞!`, 'enemy');
            
            if (ally.currentHp <= 0) {
                addBattleLog(`${ally.name} –ø–æ–≤–µ—Ä–∂–µ–Ω!`, 'enemy');
            }
            
            renderBattle();
            gameState.battle.waitingForEnemyResponse = false;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –±–∏—Ç–≤—ã
            setTimeout(checkBattleEnd, 1000);
        }
        
        // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
        function useAbility(charId, event) {
            event.stopPropagation();
            
            if (!gameState.battle.inProgress || 
                gameState.battle.waitingForEnemyResponse || 
                !gameState.battle.selectedEnemy) return;
            
            const ally = gameState.battle.allies.find(a => a.id === charId);
            if (!ally || ally.currentHp <= 0 || ally.abilityCurrentCooldown > 0 || ally.hasAttacked) return;
            
            const target = gameState.battle.selectedEnemy;
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –∞—Ç–∞–∫–∏
            const enemyElement = document.querySelector(`.enemy-card.selected`);
            if (enemyElement) {
                enemyElement.classList.add('damage-animation');
                setTimeout(() => enemyElement.classList.remove('damage-animation'), 500);
            }
            
            target.currentHp -= ally.abilityDmg;
            ally.abilityCurrentCooldown = ally.abilityCooldown;
            ally.hasAttacked = true;
            
            addBattleLog(`${ally.name} –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∏ –Ω–∞–Ω–æ—Å–∏—Ç ${ally.abilityDmg} —É—Ä–æ–Ω–∞ ${target.name}!`, 'ability');
            
            if (target.currentHp <= 0) {
                addBattleLog(`${target.name} –ø–æ–≤–µ—Ä–∂–µ–Ω!`, 'player');
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –ø–æ—Å–ª–µ –∞—Ç–∞–∫–∏
            gameState.battle.selectedCharacter = null;
            gameState.battle.selectedEnemy = null;
            
            renderBattle();
            
            // –ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –æ—Ç–≤–µ—á–∞–µ—Ç —É–¥–∞—Ä–æ–º
            setTimeout(enemyResponse, 1000);
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –±–∏—Ç–≤—ã
        function checkBattleEnd() {
            const allAlliesDead = gameState.battle.allies.every(ally => ally.currentHp <= 0);
            const allEnemiesDead = gameState.battle.enemies.every(enemy => enemy.currentHp <= 0);
            
            if (allAlliesDead) {
                endBattle(false);
            } else if (allEnemiesDead) {
                endBattle(true);
            }
        }
        
        // –ó–∞–≤–µ—Ä—à–∏—Ç—å –±–∏—Ç–≤—É
        function endBattle(playerWon) {
            if (playerWon) {
                const coinsEarned = gameState.round * 100;
                gameState.coins += coinsEarned;
                gameState.round++;
                
                addBattleLog(`=== –ü–æ–±–µ–¥–∞! –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ ${coinsEarned} –º–æ–Ω–µ—Ç ===`, 'success');
                addLogMessage(`–ü–æ–±–µ–¥–∞ –≤ —Ä–∞—É–Ω–¥–µ ${gameState.round - 1}! –ü–æ–ª—É—á–µ–Ω–æ ${coinsEarned} –º–æ–Ω–µ—Ç.`, 'player');
            } else {
                addBattleLog(`=== –ü–æ—Ä–∞–∂–µ–Ω–∏–µ! ===`, 'danger');
                addLogMessage(`–ü–æ—Ä–∞–∂–µ–Ω–∏–µ –≤ —Ä–∞—É–Ω–¥–µ ${gameState.round}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑!`, 'player');
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–¥–æ—Ä–æ–≤—å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º
            for (const charId in gameState.characters) {
                const char = gameState.characters[charId];
                if (char.unlocked) {
                    char.hp = char.maxHp;
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—É–ª–¥–∞—É–Ω—ã —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π
                    if (char.abilityCurrentCooldown !== undefined) {
                        char.abilityCurrentCooldown = 0;
                    }
                }
            }
            
            gameState.battle.inProgress = false;
            document.getElementById('start-battle-btn').disabled = false;
            document.getElementById('end-turn-btn').disabled = true;
            
            updateUI();
            renderCharacters();
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ª–æ–≥ –±–∏—Ç–≤—ã
        function addBattleLog(message, type = 'info') {
            gameState.battle.logs.push({ message, type });
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ª–æ–≥–µ
            if (gameState.battle.logs.length > 50) {
                gameState.battle.logs.shift();
            }
            
            // –ï—Å–ª–∏ –ª–æ–≥ –æ—Ç–∫—Ä—ã—Ç, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
            if (document.getElementById('battle').classList.contains('active')) {
                const battleLogContainer = document.getElementById('battle-log-container');
                if (battleLogContainer) {
                    const logElement = document.createElement('div');
                    logElement.className = `log-entry ${type}`;
                    logElement.textContent = message;
                    battleLogContainer.appendChild(logElement);
                    battleLogContainer.scrollTop = battleLogContainer.scrollHeight;
                }
            }
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ–±—â–∏–π –ª–æ–≥
        function addLogMessage(message, type = 'info') {
            // –í —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–æ—Å—Ç–æ –≤—ã–≤–æ–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å
            console.log(`[${type}] ${message}`);
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = initGame;
          function renderUpgrades() {
            const container = document.getElementById('upgrades-container');
            container.innerHTML = '';
            
            for (const charId in gameState.characters) {
                const char = gameState.characters[charId];
                if (!char.unlocked || char.maxUpgrades === 0) continue;
                
                const upgradeElement = document.createElement('div');
                upgradeElement.className = 'upgrade-card';
                upgradeElement.innerHTML = `
                    <h3><span class="character-icon" style="background-color: ${char.color}">${char.icon}</span> ${char.name}</h3>
                    <p>${char.upgradeType === 'hp' ? '+1 HP' : '+1 —É—Ä–æ–Ω'} (${char.upgradeCost} –º–æ–Ω–µ—Ç)</p>
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>–£—Ä–æ–≤–µ–Ω—å: ${char.upgrades}/${char.maxUpgrades}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${(char.upgrades / char.maxUpgrades) * 100}%"></div>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="upgradeCharacter('${char.id}')" 
                        ${char.upgrades >= char.maxUpgrades || gameState.coins < char.upgradeCost ? 'disabled' : ''}>
                        –£–ª—É—á—à–∏—Ç—å
                    </button>
                `;
                container.appendChild(upgradeElement);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ª–æ–≥
        function addLogMessage(message, type = 'info') {
            console.log(`[${type}] ${message}`);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updateUI() {
            coinsElement.textContent = gameState.coins;
            roundElement.textContent = gameState.round;
            chestPriceElement.textContent = gameState.chest.currentPrice;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            updateUI();
            renderCharacters();
            renderUpgrades();
        };
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
function initNewCharacters() {
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
    gameState.characters.tough = {
        id: 'tough',
        name: '–¢–∞—Ñ',
        hp: 20,
        maxHp: 20,
        dmg: 3,
        upgrades: 0,
        maxUpgrades: 3,
        upgradeCost: 200,
        upgradeType: 'both',
        icon: 'üí™',
        color: '#8bc34a',
        unlocked: false
    };
    
    gameState.characters.builderman = {
        id: 'builderman',
        name: '–ë–∏–ª–¥–µ—Ä–º–µ–Ω',
        hp: 25,
        maxHp: 25,
        dmg: 0,
        ability: 'buff',
        abilityCooldown: 10,
        abilityCurrentCooldown: 0,
        upgrades: 0,
        maxUpgrades: 0,
        icon: 'üë∑',
        color: '#ff9800',
        unlocked: false
    };
    
    gameState.characters.agent = {
        id: 'agent',
        name: '007h0',
        hp: 20,
        maxHp: 20,
        dmg: 5,
        ability: 'clone',
        abilityCooldown: 999,
        abilityCurrentCooldown: 0,
        upgrades: 0,
        maxUpgrades: 1,
        upgradeCost: 1000,
        upgradeType: 'ability',
        icon: 'üï∂Ô∏è',
        color: '#000000',
        unlocked: false
    };
}

// –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–∞ —Å –î–∂–µ–π–Ω –î–æ—É
function fixJaneBug() {
    gameState.characters.jane.healAmount = 2; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–µ—á–µ–Ω–∏–µ
    gameState.characters.jane.maxHp = 30; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–¥–æ—Ä–æ–≤—å–µ
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π
function useAbility(character) {
    if (character.abilityCurrentCooldown > 0) return false;
    
    switch(character.ability) {
        case 'buff':
            // –ë–∏–ª–¥–µ—Ä–º–µ–Ω –¥–∞–µ—Ç +2 —É—Ä–æ–Ω–∞ —Å–ª—É—á–∞–π–Ω–æ–º—É —Å–æ—é–∑–Ω–∏–∫—É
            const allies = gameState.battle.allies.filter(a => a.currentHp > 0 && a.id !== character.id);
            if (allies.length > 0) {
                const target = allies[Math.floor(Math.random() * allies.length)];
                target.dmg += 2;
                target.buffed = true;
                addBattleLog(`${character.name} —É—Å–∏–ª–∏–≤–∞–µ—Ç ${target.name}! +2 —É—Ä–æ–Ω–∞`, 'ability');
            }
            break;
            
        case 'clone':
            // –ê–≥–µ–Ω—Ç —Å–æ–∑–¥–∞–µ—Ç –∫–ª–æ–Ω–∞ –Ω–∞ 1 —Ä–∞—É–Ω–¥
            const clone = {...character};
            clone.id = `${character.id}-clone`;
            clone.name = `–ö–ª–æ–Ω ${character.name}`;
            gameState.battle.allies.push(clone);
            addBattleLog(`${character.name} —Å–æ–∑–¥–∞–µ—Ç —Å–≤–æ–µ–≥–æ –∫–ª–æ–Ω–∞!`, 'ability');
            break;
            
        default:
            return false;
    }
    
    character.abilityCurrentCooldown = character.abilityCooldown;
    return true;
}

// –ù–æ–≤—ã–π —Å—É–Ω–¥—É–∫ (–ø—Ä–µ–º–∏—É–º)
function openPremiumChest() {
    if (gameState.coins < gameState.premiumChest.currentPrice) {
        addLogMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç –¥–ª—è –ø—Ä–µ–º–∏—É–º —Å—É–Ω–¥—É–∫–∞!', 'player');
        return;
    }
    
    gameState.coins -= gameState.premiumChest.currentPrice;
    gameState.premiumChest.currentPrice += gameState.premiumChest.priceIncrease;
    
    const random = Math.random() * 100;
    let unlockedChar = null;
    
    if (random <= 1) {
        unlockedChar = 'agent';
    } else if (random <= 30) {
        unlockedChar = 'builderman';
    } else {
        unlockedChar = 'tough';
    }
    
    // ... (–ª–æ–≥–∏–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞ –æ–±—ã—á–Ω–æ–º—É —Å—É–Ω–¥—É–∫—É)
}

// –ù–æ–≤—ã–µ –≤—Ä–∞–≥–∏ –¥–ª—è —Ä–∞—É–Ω–¥–æ–≤
function generateEnemies() {
    const round = gameState.round;
    gameState.battle.enemies = [];
    
    if (round === 4) {
        // 3 –±–æ–ª—å—à–∏—Ö
        for (let i = 0; i < 3; i++) addEnemy(true);
    } 
    else if (round === 5) {
        // 3 –º–∞–ª–µ–Ω—å–∫–∏—Ö + 1 –±–æ–ª—å—à–æ–π
        for (let i = 0; i < 3; i++) addEnemy(false);
        addEnemy(true);
    }
    // ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏)
    else {
        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - –æ–±—ã—á–Ω—ã–µ –≤—Ä–∞–≥–∏
        for (let i = 0; i < round; i++) addEnemy(false);
    }
}

function addEnemy(isBig) {
    gameState.battle.enemies.push({
        id: `enemy-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
        name: isBig ? '–ë–æ–ª—å—à–æ–π –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫' : '–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫',
        currentHp: isBig ? 15 : 5,
        maxHp: isBig ? 15 : 5,
        dmg: isBig ? 4 : 1,
        isBig: isBig
    });
}

// –°–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
function useItem(itemType, target) {
    switch(itemType) {
        case 'medkit':
            target.currentHp = Math.min(target.currentHp + 20, target.maxHp);
            addBattleLog(`–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –∞–ø—Ç–µ—á–∫–∞ –Ω–∞ ${target.name}! +20 HP`, 'heal');
            break;
            
        case 'bomb':
            const enemies = gameState.battle.enemies.filter(e => e.currentHp > 0);
            if (enemies.length > 0) {
                const targetEnemy = enemies[Math.floor(Math.random() * enemies.length)];
                targetEnemy.currentHp -= 10;
                addBattleLog(`–ë–æ–º–±–∞ –Ω–∞–Ω–æ—Å–∏—Ç 10 —É—Ä–æ–Ω–∞ ${targetEnemy.name}!`, 'ability');
            }
            break;
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
window.onload = function() {
    initNewCharacters();
    fixJaneBug();
    
    gameState.premiumChest = {
        basePrice: 1000,
        currentPrice: 1000,
        priceIncrease: 1000
    };
    
    updateUI();
    renderCharacters();
    renderUpgrades();
    renderShop();
};
        // ======================
// –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –°–ü–û–°–û–ë–ù–û–°–¢–ï–ô
// ======================

function handleAbilities() {
    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –ë–µ–∫–æ–Ω–∞
    gameState.characters.bacon.ability = 'damage';
    
    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –ö–∏—Ä–ø–∏—á–∞
    gameState.characters.brick.ability = 'strongAttack';
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
    gameState.characters.builderman = {
        ability: 'buffAlly',
        abilityCooldown: 10,
        abilityCurrentCooldown: 0
    };
    
    gameState.characters.agent = {
        ability: 'cloneSelf',
        abilityCooldown: 999,
        abilityCurrentCooldown: 0
    };
}

function useCharacterAbility(characterId) {
    const character = gameState.characters[characterId];
    if (!character || !character.ability || character.abilityCurrentCooldown > 0) return false;

    switch(character.ability) {
        case 'damage': // –ë–µ–∫–æ–Ω
            addBattleLog(`${character.name} –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–æ—â–Ω—É—é –∞—Ç–∞–∫—É!`, 'ability');
            return true;
            
        case 'strongAttack': // –ö–∏—Ä–ø–∏—á
            addBattleLog(`${character.name} –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É–ø–µ—Ä-—É–¥–∞—Ä!`, 'ability');
            return true;
            
        case 'buffAlly': // –ë–∏–ª–¥–µ—Ä–º–µ–Ω
            const allies = gameState.battle.allies.filter(a => a.currentHp > 0 && a.id !== character.id);
            if (allies.length > 0) {
                const target = allies[Math.floor(Math.random() * allies.length)];
                target.dmg += 2;
                addBattleLog(`${character.name} —É—Å–∏–ª–∏–≤–∞–µ—Ç ${target.name}! +2 —É—Ä–æ–Ω–∞`, 'ability');
            }
            return true;
            
        case 'cloneSelf': // –ê–≥–µ–Ω—Ç
            const clone = {...gameState.characters[characterId]};
            clone.id = `${characterId}-clone`;
            clone.name = `–ö–ª–æ–Ω ${character.name}`;
            gameState.battle.allies.push(clone);
            addBattleLog(`${character.name} —Å–æ–∑–¥–∞–µ—Ç –∫–ª–æ–Ω–∞!`, 'ability');
            return true;
            
        default:
            return false;
    }
}

// ======================
// –ü–†–ï–ú–ò–£–ú –°–£–ù–î–£–ö
// ======================

function initPremiumChest() {
    gameState.premiumChest = {
        basePrice: 1000,
        currentPrice: 1000,
        priceIncrease: 1000,
        contents: [
            { type: 'tough', chance: 70 },
            { type: 'builderman', chance: 29 },
            { type: 'agent', chance: 1 }
        ]
    };
}

function openPremiumChest() {
    if (gameState.coins < gameState.premiumChest.currentPrice) {
        addLogMessage(`–ù—É–∂–Ω–æ ${gameState.premiumChest.currentPrice} –º–æ–Ω–µ—Ç –¥–ª—è –ø—Ä–µ–º–∏—É–º —Å—É–Ω–¥—É–∫–∞!`, 'error');
        return;
    }

    gameState.coins -= gameState.premiumChest.currentPrice;
    gameState.premiumChest.currentPrice += gameState.premiumChest.priceIncrease;

    const random = Math.random() * 100;
    let reward = null;
    let cumulativeChance = 0;

    for (const item of gameState.premiumChest.contents) {
        cumulativeChance += item.chance;
        if (random <= cumulativeChance) {
            reward = item.type;
            break;
        }
    }

    // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    if (reward && !gameState.characters[reward].unlocked) {
        gameState.characters[reward].unlocked = true;
        gameState.characters[reward].hp = gameState.characters[reward].maxHp;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        const chestResult = document.getElementById('chest-result');
        chestResult.innerHTML = `
            <div class="chest-reward">
                <h3>üéâ –ü–æ–ª—É—á–µ–Ω –Ω–æ–≤—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂!</h3>
                <p>${gameState.characters[reward].name} ${gameState.characters[reward].icon}</p>
                <p>${getCharacterDescription(reward)}</p>
            </div>
        `;
        
        addLogMessage(`–û—Ç–∫—Ä—ã—Ç –ø—Ä–µ–º–∏—É–º —Å—É–Ω–¥—É–∫: –ø–æ–ª—É—á–µ–Ω ${gameState.characters[reward].name}!`, 'success');
    } else if (reward) {
        // –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –∑–∞ –¥—É–±–ª–∏–∫–∞—Ç
        const refund = Math.floor(gameState.premiumChest.currentPrice * 0.5);
        gameState.coins += refund;
        
        const chestResult = document.getElementById('chest-result');
        chestResult.innerHTML = `
            <div class="chest-reward">
                <h3>üéÅ –î—É–±–ª–∏–∫–∞—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h3>
                <p>–ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è: ${refund} –º–æ–Ω–µ—Ç</p>
            </div>
        `;
    }

    updateUI();
    renderCharacters();
    renderUpgrades();
}

// ======================
// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ì–†–´
// ======================

function initGame() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π
    handleAbilities();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–µ–º–∏—É–º —Å—É–Ω–¥—É–∫–∞
    initPremiumChest();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
    gameState.characters.tough = {
        id: 'tough',
        name: '–¢–∞—Ñ',
        hp: 20,
        maxHp: 20,
        dmg: 3,
        upgrades: 0,
        maxUpgrades: 3,
        upgradeCost: 200,
        upgradeType: 'both', // +1 —É—Ä–æ–Ω –∏ +2 HP
        icon: 'üí™',
        color: '#8bc34a',
        unlocked: false
    };
    
    gameState.characters.builderman = {
        id: 'builderman',
        name: '–ë–∏–ª–¥–µ—Ä–º–µ–Ω',
        hp: 25,
        maxHp: 25,
        dmg: 0,
        ability: 'buffAlly',
        abilityCooldown: 10,
        abilityCurrentCooldown: 0,
        upgrades: 0,
        maxUpgrades: 0,
        icon: 'üë∑',
        color: '#ff9800',
        unlocked: false
    };
    
    gameState.characters.agent = {
        id: 'agent',
        name: '007h0',
        hp: 20,
        maxHp: 20,
        dmg: 5,
        ability: 'cloneSelf',
        abilityCooldown: 999,
        abilityCurrentCooldown: 0,
        upgrades: 0,
        maxUpgrades: 1,
        upgradeCost: 1000,
        upgradeType: 'ability',
        icon: 'üï∂Ô∏è',
        color: '#000000',
        unlocked: false
    };

    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –î–∂–µ–π–Ω –î–æ—É
    gameState.characters.jane.healAmount = 2;
    gameState.characters.jane.maxHp = 30;

    updateUI();
    renderCharacters();
    renderUpgrades();
    renderShop();
}

// –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.onload = initGame;
        // ======================
// –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ë–ò–õ–î–ï–†–ú–ï–ù–ê –ò –ê–ì–ï–ù–¢–ê
// ======================

function fixBuildermanAbility() {
    // –£–±–µ–¥–∏–º—Å—è —á—Ç–æ –ë–∏–ª–¥–µ—Ä–º–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
    if (!gameState.characters.builderman) {
        gameState.characters.builderman = {
            id: 'builderman',
            name: '–ë–∏–ª–¥–µ—Ä–º–µ–Ω',
            hp: 25,
            maxHp: 25,
            dmg: 0,
            ability: 'buffAlly',
            abilityCooldown: 2,  // –£–º–µ–Ω—å—à–∏–ª –∫—É–ª–¥–∞—É–Ω –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            abilityCurrentCooldown: 0,
            upgrades: 0,
            maxUpgrades: 0,
            icon: 'üë∑',
            color: '#ff9800',
            unlocked: false
        };
    }

    // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
    gameState.characters.builderman.useAbility = function() {
        if (this.abilityCurrentCooldown > 0) return false;
        
        const allies = gameState.battle.allies.filter(a => 
            a.currentHp > 0 && 
            a.id !== this.id && 
            !a.buffed
        );
        
        if (allies.length > 0) {
            const target = allies[Math.floor(Math.random() * allies.length)];
            target.bonusDmg = (target.bonusDmg || 0) + 2;
            target.buffed = true;
            this.abilityCurrentCooldown = this.abilityCooldown;
            
            addBattleLog(`${this.name} —É—Å–∏–ª–∏–≤–∞–µ—Ç ${target.name}! +2 —É—Ä–æ–Ω–∞`, 'ability');
            renderBattle();
            return true;
        }
        return false;
    };
}

function fixAgentAbility() {
    // –£–±–µ–¥–∏–º—Å—è —á—Ç–æ –∞–≥–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
    if (!gameState.characters.agent) {
        gameState.characters.agent = {
            id: 'agent',
            name: '007h0',
            hp: 20,
            maxHp: 20,
            dmg: 5,
            ability: 'cloneSelf',
            abilityCooldown: 1,  // –£–º–µ–Ω—å—à–∏–ª –∫—É–ª–¥–∞—É–Ω –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            abilityCurrentCooldown: 0,
            upgrades: 0,
            maxUpgrades: 1,
            upgradeCost: 1000,
            upgradeType: 'ability',
            icon: 'üï∂Ô∏è',
            color: '#000000',
            unlocked: false
        };
    }

    // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
    gameState.characters.agent.useAbility = function() {
        if (this.abilityCurrentCooldown > 0) return false;
        
        const clone = {
            ...this,
            id: `${this.id}-clone-${Date.now()}`,
            name: `–ö–ª–æ–Ω ${this.name}`,
            isClone: true
        };
        
        gameState.battle.allies.push(clone);
        this.abilityCurrentCooldown = this.abilityCooldown;
        
        addBattleLog(`${this.name} —Å–æ–∑–¥–∞–µ—Ç –∫–ª–æ–Ω–∞!`, 'ability');
        renderBattle();
        return true;
    };
}

// ======================
// –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –°–ü–û–°–û–ë–ù–û–°–¢–ï–ô –í –ë–û–Æ
// ======================

function handleAbilityInBattle(characterId) {
    const character = gameState.battle.allies.find(c => c.id === characterId);
    if (!character || !character.useAbility) return false;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—É–ª–¥–∞—É–Ω –∏ –º–æ–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
    if (character.abilityCurrentCooldown > 0 || character.currentHp <= 0) {
        addBattleLog(`–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å ${character.name} –Ω–∞ –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–µ!`, 'error');
        return false;
    }
    
    return character.useAbility();
}

// ======================
// –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
// ======================

function initGame() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
    initNewCharacters();
    fixJaneBug();
    
    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π
    fixBuildermanAbility();
    fixAgentAbility();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—É–Ω–¥—É–∫–æ–≤
    initPremiumChest();
    
    updateUI();
    renderCharacters();
    renderUpgrades();
    renderShop();
    
    // –¢–µ—Å—Ç–æ–≤—ã–π –≤—ã–≤–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    console.log("–ë–∏–ª–¥–µ—Ä–º–µ–Ω –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω:", gameState.characters.builderman);
    console.log("–ê–≥–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω:", gameState.characters.agent);
}

// –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
window.onload = initGame;
    </script>
</body>
</html>
</body>
</html>           
